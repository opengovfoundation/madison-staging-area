machine:
  environment:
    APP_URL: http://0.0.0.0:8888
    APP_ENV: testing
    DB_HOST: localhost
    DB_DATABASE: circle_test
    DB_USERNAME: ubuntu
    APP_DEBUG: true
    CIRCLE_COMMIT_MSG: $(git log --format=%B -n 1 $CIRCLE_SHA1)

  node:
    version: 4.1

  php:
    version: 5.6.22


dependencies:
  override:
    - make deps

  post:
    # Undo CircleCI broken link
    - sudo unlink /usr/lib/apache2/modules/libphp5.so
    # Make proper link
    - sudo ln -s $PHPENV_ROOT/versions/$(phpenv global)/usr/lib/apache2/modules/libphp5.so /usr/lib/apache2/modules/libphp5.so
    # Setup environment for Apache
    - echo "export APP_URL=$APP_URL" >> /etc/apache2/envvars
    - echo "export APP_DEBUG=$APP_DEBUG" >> /etc/apache2/envvars
    - echo "export APP_ENV=$APP_ENV" >> /etc/apache2/envvars
    - echo "export TESTING=$TESTING" >> /etc/apache2/envvars
    - echo "export DB_CONNECTION=$DB_CONNECTION" >> /etc/apache2/envvars
    - echo "export DB_HOST=$DB_HOST" >> /etc/apache2/envvars
    - echo "export DB_USERNAME=$DB_USERNAME" >> /etc/apache2/envvars
    - echo "export DB_DATABASE=$DB_DATABASE" >> /etc/apache2/envvars
    # Install our config and make it active
    - sudo cp -f circleci/apache.conf /etc/apache2/sites-available/madison.conf
    - sudo a2enmod rewrite actions alias headers negotiation dir vhost_alias deflate
    - sudo a2ensite madison
    - sudo service apache2 restart
    # Fix connection to MySQL
    - echo "pdo_mysql.default_socket=/var/run/mysqld/mysqld.sock" > /opt/circleci/php/$(phpenv global)/etc/conf.d/mysql.ini
    # Let Apache write Laravel log files
    - sudo chgrp -R www-data ./server/storage
    # Prepare SauceLabs connector
    - wget https://saucelabs.com/downloads/sc-latest-linux.tar.gz
    - tar -xzf sc-latest-linux.tar.gz

  cache_directories:
    - "client/node_modules"
    - "server/vendor"


# database:
  # override:
    # - mysql -e 'create database madison_testing;'


test:
  override:
    - cd sc-*-linux && ./bin/sc --user $SAUCE_USERNAME --api-key $SAUCE_ACCESS_KEY --readyfile ~/sauce_is_ready:
        background: true
    # Wait for tunnel to be ready
    - while [ ! -e ~/sauce_is_ready ]; do sleep 1; done
    - make test

  post:
    - killall --wait sc # wait for Sauce Connect to close the tunnel
    - cp /var/log/apache2/error.log $CIRCLE_ARTIFACTS/apache_error.log
    - cp /var/log/apache2/other_vhosts_acces.log $CIRCLE_ARTIFACTS/apache_traffic.log
    - cp ./server/storage/logs/laravel.log $CIRCLE_ARTIFACTS/laravel.log


notify:
  webhooks:
    - url: https://phabricator.opengovfoundation.org/harbormaster/hook/circleci/
