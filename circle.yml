machine:
  environment:
    APP_URL: http://0.0.0.0:8888
    APP_ENV: testing
    DB_HOST: localhost
    DB_DATABASE: madison_testing
    DB_USERNAME: root
    APP_DEBUG: true

  node:
    version: 4.1

  php:
    version: 5.6.22


dependencies:
  override:
    - make deps

  post:
    # Undo CircleCI broken link
    - sudo unlink /usr/lib/apache2/modules/libphp5.so
    # Make proper link
    - sudo ln -s $PHPENV_ROOT/versions/$(phpenv global)/usr/lib/apache2/modules/libphp5.so /usr/lib/apache2/modules/libphp5.so
    # Install our config and make it active
    - sudo cp -f circleci/apache.conf /etc/apache2/sites-available/madison.conf
    - sudo a2enmod rewrite actions alias headers negotiation dir vhost_alias deflate
    - sudo a2ensite madison
    - sudo service apache2 restart
    - echo "pdo_mysql.default_socket=/var/run/mysqld/mysqld.sock" > /opt/circleci/php/$(phpenv global)/etc/conf.d/mysql.ini

  cache_directories:
    - "client/node_modules"
    - "server/vendor"


database:
  override:
    - mysql -e 'create database madison_testing;'


test:
  override:
    - make test


notify:
  webhooks:
    - url: https://phabricator.opengovfoundation.org/harbormaster/hook/circleci/
